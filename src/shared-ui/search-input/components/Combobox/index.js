//
//
//
// react-select is a pile of hot garbage
// and everyone please stay away from it
// its unmoddable
// its extremely inconsistent
// its untouchable
// every componentent receives different "mandatory" props
// not all components have their own ... component, yeah
// they ENFORCE you to use their styling style
// etc etc
// i can't use refs ... ... please tell how
//
// why is everyone recommending it
// have they ever put their hands on it ???
// bruh im loaded af, i will end up in a mental hospital
// an entire fucking week trying to implement the most basic react shit
// if i spent the same time implementing the lacking features of headless's
// combobox, that would have ended much sooner, and better implemented that any
// of this crap
//
// with less than one month of experience in react i've developed more robust
// shit than this
//
//
// bruh im pretty sure someone's gonna come in and tell me "bro.. skill issue,
// you are just an amateur, you didn't read the documentation correctly [...]"
// and you know wha? they might be right ... its a shame that the props
// cum-entation is an extremely long ass unreadable page with repeated words
// .... and every time you read about a new component feels like they have just
// introduced you new concepts over and over again
// thats inhuman, i used headless and i understood it instantly
// clearly they didn't keep the react-way of doing things
//
//
// please stop developing this
// its horrendous
//
//⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡀⠀⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠆⠀⠀⠀⠀⠄⠀⠈⢀⠄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢰⠁⢀⢀⠀⠀⠀⠈⠀⢀⡰⣊⢤⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⡀⠀⠠⠠⠈⠂⠁⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡠⣍⠄⡂⡺⡀⡰⢄⡀⣔⡲⢞⡩⢥⡰⠂⠀⠀⠀⢀⢀⠒⡤⠜⠠⢔⣈⠣⠄⡀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⠀⠀⣀⣀⣀⣤⣀⡀⠀⠀⠀⠀⠹⠞⡾⠀⠀⠀⡝⢦⡙⡵⣀⠦⣑⢫⡏⣴⣣⡜⠔⠁⡢⢉⣴⡋⢄⠢⡜⣢⠳⠔⠃⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣬⣶⣾⣿⣿⣿⣿⣿⣿⣿⣿⣶⣄⠀⢨⢟⡄⢸⢀⡗⣩⢶⣒⢦⣙⣮⠵⢫⡜⢧⢒⠐⣀⠀⣆⡲⡎⠸⡞⣋⣙⠃⠒⣲⠄⠂
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⢀⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣄⣯⢷⠀⠸⠜⠑⠉⠁⠀⠒⠂⠒⠂⠐⢸⡌⠳⢤⡹⠐⠴⠠⢁⡐⣠⠤⢤⣊⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣵⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣮⡭⠑⠀⠀⠁⠂⢀⠀⠀⠀⠀⠀⠀⠀⢳⡍⡖⣝⢪⡡⠄⠜⠘⠡⢒⢀⣀⢏⡫⠭
// ⠀⠀⠀⠀⠀⠀⠀⠀⢀⢂⠈⠉⠛⠛⠛⠿⠿⠿⢿⣿⣿⣿⣿⣿⣿⣿⣿⠟⠛⣁⡄⠀⠀⠈⡄⠀⡀⠀⠂⠠⠀⠀⠀⠀⠀⠹⣜⢆⣳⡥⡌⠃⡴⣠⠎⢙⠁⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⢹⡏⣿⡟⡏⢿⡿⣿⣿⢢⢀⠆⢀⡇⠀⢹⣈⠐⠀⠠⠄⢁⣂⣐⠂⠈⣳⢧⡘⢝⡦⡀⢡⠀⠄⢀⠉⠢⡀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⠃⡿⡁⡾⢠⣿⠳⣇⠈⣇⣹⡏⠆⣾⢃⠞⠼⡀⠸⣇⣆⠰⣢⢀⠀⡈⡀⠠⠐⠙⢫⣵⡰⡝⠻⡦⣔⠀⠠⠀⠀⠈
// ⠀⠀⠀⠀⠀⠀⠀⠀⠐⣹⣿⣿⣿⣿⣿⣿⣿⢏⣴⣿⡛⠃⢄⠋⠸⢱⣿⡍⠹⢻⢠⠻⡶⣄⠈⢇⠰⠌⢮⡉⠻⣧⡐⠠⠏⠤⣀⠀⠘⣽⣵⡐⡀⠊⠹⠫⣒⠤⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣧⠻⣿⣿⣿⣿⡄⠟⠿⠧⠁⠀⠀⠀⠈⠿⠃⠀⣟⣸⠸⢰⣟⠀⢘⠤⠀⢶⠿⣤⡻⣧⡁⣟⠰⣀⠣⣬⣘⣯⠣⡘⡀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣯⣙⣿⣿⣿⣷⠀⠀⠀⠀⠀⠀⠂⠀⠀⠀⢀⡿⢿⠀⠈⠂⠀⠀⠘⠀⠁⣶⣿⣧⠳⣷⢸⡐⣦⡿⣳⡫⠂⠀⠈⠢⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⣿⣿⣿⣿⣿⣿⣿⣧⠀⠀   ⠐⠀⠀⢀⣴⣿⠃⢸⡀⠀⠐⠀⠀⠀⠀⠉⢯⡽⠁⠜⡜⠳⡜⢆⡿⠕⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⣂⠤⠀⣀⣤⣾⣿⡿⣟⣤⠀⣛⡦⡈⠂⡀⣀⠀⠀⠀⢀⣌⠞⣈⠽⡀⠑⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⢀⣾⣿⣿⣿⣿⣿⠿⡿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠇⢁⡡⠀⠘⡅⠡⠤⠤⢀⡀⠀⢤⡮⢒⣴⣭⣶⡶⣾⣞⠯⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⣠⣿⣿⣿⣿⣿⣿⢏⡳⣙⠮⡜⡻⢿⣿⣿⣿⣿⣿⡟⢣⠀⠀⡁⢶⠀⠀⠀⠄⢀⠨⠻⢿⡫⠔⠁⠀⠙⠿⣦⣄⢀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⣠⣾⣿⣿⣿⣿⣿⣿⢏⡚⡴⡩⢖⠭⣓⢭⣛⣿⣿⣿⡟⢠⢨⠀⠌⢡⢰⡦⠀⠄⠀⢃⢠⠂⠃⠀⠀⠀⠀⠀⠐⡀⠉⠋⠞⡉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⢀⣠⣾⣿⣿⣿⣿⣿⣿⣿⣟⣮⣟⠭⣓⠯⣞⡡⢖⠦⣙⣿⣿⡇⠸⠀⠀⠀⠆⢸⡡⠂⣀⢢⡿⠋⡈⠂⠀⠀⠀⠀⠀⠀⠠⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⣴⣿⣿⠿⠋⢡⣿⣿⣿⣿⣿⣿⣿⣿⠄⠀⢛⡲⢝⡺⢥⣣⣾⣿⠁⠀⠀⠀⠀⢠⠃⡎⣫⠡⣱⠠⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⢨⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠛⠉⠀⠀⢠⣾⣿⣿⣿⣿⣿⣿⣿⣿⣇⠀⠀⠙⣄⠙⡳⢏⣾⡿⡀⠀⠀⢀⣶⠝⠈⠭⠁⠀⡱⠐⠀⠀⠀⠀⠀⠀⠀⠀⠀⡠⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⢠⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡆⠠⠀⠠⠕⢥⢀⣼⣷⣿⣷⠎⠉⠀⠀⠈⠁⠀⡴⠃⢀⡀⢽⣶⣶⣬⣡⡄⣢⠹⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⣠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣯⠀⠑⠢⠠⢂⣽⣿⣿⣿⣿⠀⠀⠀⠀⠰⡰⠈⢼⡉⡗⠀⠀⢂⠉⠉⠙⢉⣀⠁⢂⠄⢀⡀⠀⠀⢀⢀⡤⠦⠠⠓⠒⢶⡖
// ⠀⣴⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡔⠀⢀⢪⡔⢸⣿⣿⣿⣿⡄⡣⠀⠀⠀⡆⠛⢧⡜⡙⡟⡦⠀⠀⣠⣄⣀⣰⡾⠝⣠⡞⠍⠋⠄⠐⠀⠀⠀⠀⠀⠈⠐⣳
// ⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⠀⠃⡎⠄⡾⠋⢻⣿⣿⣷⢺⡘⡆⢂⠁⠀⠀⠑⠵⠁⠘⠻⢛⠳⡩⢍⣹⠀⡰⠋⠀⠁⠀⠀⠀⠀⠀⠀⠀⣀⣴⠟⠁
// ⣿⣿⣿⣻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡯⠐⡐⠀⠘⠁⠀⠀⠻⣿⡟⠂⡐⢨⡑⢄⠀⠀⠀⠀⠀⠀⢀⠎⡵⢱⠊⠀⢈⢂⠀⠀⢀⠠⢂⢌⢂⣦⣵⡿⠟⠓⠈⠁
// ⡿⠟⣰⣿⣿⣿⣿⣿⣿⣿⡿⠿⣛⢋⣁⣀⣀⠀⠇⠀⠀⠀⠀⠀⠄⠈⢀⠄⡧⠸⠐⠁⠀⠄⠀⠀⠀⢀⢎⡚⡔⢋⡞⣍⠫⡜⢭⠲⣅⣫⣼⣾⡿⠋⠁⠀⠀⠀⠀⠀
// ⠀⢠⣿⣿⣿⣿⣿⣿⢿⣷⣿⣿⣿⣿⣿⣿⣿⣿⣿⣇⠀⠀⠀⠀⠀⠀⠀⢀⡇⠠⠈⡆⠀⠀⠠⣒⡤⣃⠎⡴⠋⢸⠜⣰⢋⡜⡆⣏⠼⡍⠥⠍⠈⠙⡒⠶⣤⣀⠀⠀
// ⠀⣿⣿⣿⠿⡻⢵⡚⢯⠭⣭⠹⣌⡲⣳⣵⣿⣿⣿⣿⡄⠀⠀⠀⠀⠂⣁⢲⣷⡄⠁⣷⡄⠀⠀⠠⣻⡔⣩⠁⠀⣨⢻⢏⡚⡴⣩⢆⡳⡼⠀⠀⠀⠀⠀⠀⠐⠈⡓⣦
// ⡰⡿⢓⡕⢮⡱⢣⡝⡬⢳⡤⣓⠵⣩⢓⡬⡝⣿⣿⣿⣿⡀⠀⠀⠀⠀⠀⢹⣿⣿⡄⢸⣿⣆⠀⠠⠢⣻⢴⡒⢶⣫⣝⣾⡻⣝⣣⢾⣹⢏⡝⠁⠀⠀⠀⠀⠀⠀⠀⠈
// ⠋⡴⡹⣜⢣⡝⣣⢜⠵⡉⣤⠓⣮⢱⡩⢖⡩⢞⣿⣿⣿⣧⠀⠀⠀⠀⠀⣿⣿⣿⣿⡄⢿⡿⢂⢴⡹⢥⢣⡟⣻⠱⣎⢿⢯⣛⠛⠮⠵⠫⠵⡉⠄⣀⠀⡀⢀⠀⡈⠤
// ⡝⣲⠱⣎⠳⣜⠕⣁⠲⣍⠶⣙⠴⢣⡱⢫⡔⣻⡿⣿⣿⣿⣆⠀⠀⠀⢠⣿⣿⣿⣿⣿⠊⠀⠀⠣⡓⢎⡣⢞⣡⠳⣘⢾⡻⣌⠳⣕⠨⡑⢢⠑⡌⢄⣣⣌⣢⡼⠶⠛
// ⠈⠥⢟⣬⣓⠁⣴⢩⠳⣌⠳⡥⡛⣆⢳⠱⢼⡿⢲⡹⣿⣿⣿⡄⠀⠀⣸⣿⣿⣿⣿⠁⠀⠀⠀⢀⡌⠣⣓⠮⡔⣫⢜⠃⢱⣊⢷⠜⠻⡛⠚⠛⠛⠛⠉⠉⠁⠀⠀⠀
// ⢀⣾⣅⠀⠀⠀⡱⣍⠳⣌⢳⡑⡳⣌⢇⣫⣿⡓⢧⡱⡹⣿⣿⣷⡀⠀⣿⣿⣿⣿⠇⠀⠀⠀⢠⡼⣣⠀⠀⠙⠓⢥⠏⠀⠀⢳⡞⠀⠀⠈⠢⠐⠄⠀⠀⠀⠀⠀⠀⠀
// ⣿⣿⣿⣷⢠⠋⢀⡏⠑⠎⣧⡙⡖⣥⢚⣼⡯⢜⢥⢣⢓⡏⢿⣿⣧⢠⣿⣿⣿⡏⠀⠀⠀⣠⠟⢠⠹⣄⠀⠀⠀⠀⠀⠀⠀⠈⣧⠀⠀⠀⠀⠀⠀⠑⡄⠀⠀⠀⠀⠀
//
//
// thats my rant for today, plese send an email to yavierre_the_666@hotmail.com
// if u want me to develop you a way cooler, easy to use, easy to read,
// AAA accesibility rating combobox solution
//
// kiss kiss gay kiss
// *hug*
// *pet*
// *and a smooth suck*
//
//
//
//

// React
import { useRef } from "react";
import Select from "react-select";
// Components
import {
  SelectContainer,
  selectContainerStyles,
} from "./components/SelectContainer";
import { Control, controlStyles } from "./components/Control";
import { Input } from "./components/Input";
import {
  ValueContainer,
  valueContainerStyles,
} from "./components/ValueContainer";
import { MultiValue, multiValueStyles } from "./components/MultiValue";
import {
  MultiValueContainer,
  multiValueContainerStyles,
} from "./components/MultiValueContainer";
import { MultiValueLabel } from "./components/MultiValueLabel";
import {
  MultiValueRemove,
  multiValueRemoveStyles,
} from "./components/MultiValueRemove";
import { Placeholder, placeholderStyles } from "./components/Placeholder";
import { Menu, menuStyles } from "./components/Menu";
import { MenuList, menuListStyles } from "./components/MenuList";
import { Option, optionStyles } from "./components/Option";
// Hooks
import { useSuggestions } from "./hooks/useSuggestions";
// Utils
import { getFormattedValue } from "./utils/getFormattedValue";
import { getSelectionInput } from "./utils/getSelectionInput";

//
//
//

export const Combobox = ({
  // Mandatory
  data,
  options,
  inputValue,
  inputCallback,
  selectedValues,
  selectedCallback,

  // Optional
  maxSuggestionCount = 5,
  isLoading = false,
  placeholder,
  loadingMessage,
  noMatchesMessage,
  className = "",
}) => {
  //
  // Suggestions and formatting
  //

  const selection = isLoading
    ? []
    : Object.keys(selectedValues).reduce(
        (acum, category) => [
          ...acum,
          ...selectedValues[category].map((value) =>
            getFormattedValue(category, value)
          ),
        ],
        []
      );

  const filteredOptions = options.filter((category) => {
    const catInSelection = selectedValues[category.name];

    if (catInSelection) {
      if (catInSelection.length >= (category.maxAllowed || 1)) {
        return false;
      } else {
        return true;
      }
    } else {
      return true;
    }
  });

  const { findSuggestions } = useSuggestions(
    data,
    inputValue,
    filteredOptions,
    maxSuggestionCount
  );

  let suggestions = [];

  if (data) {
    suggestions = findSuggestions().map(({ category, match }) =>
      getFormattedValue(category, match)
    );
  }

  //
  // Styles
  //

  const containerElement = useRef(null);
  const valueContainerElement = useRef(null);
  const multiValueContainerElements = useRef([]);

  const customStyles = {
    container: selectContainerStyles,
    control: controlStyles,
    placeholder: placeholderStyles,
    valueContainer: valueContainerStyles,
    multiValue: multiValueContainerStyles,
    multiValueRemove: multiValueRemoveStyles,
    clearIndicator: (provided) => ({ ...provided, cursor: "pointer" }),
    menu: menuStyles,
    menuList: menuListStyles,
    option: optionStyles,
  };

  //
  // Callbacks
  //

  const handleSelectionChange = (selection, event) => {
    selectedCallback(getSelectionInput(selection), false);
    if (event.action === "clear" && inputValue.length > 0) {
      inputCallback("");
    }
  };

  const handleInput = (input, event) => {
    const listOfEvents = ["input-change", "set-value"];
    if (listOfEvents.includes(event.action)) {
      inputCallback(input);
    }
  };

  //
  //
  //

  //
  //
  //

  return (
    <div className={className}>
      <Select
        isMulti
        value={selection}
        onChange={handleSelectionChange}
        inputValue={inputValue}
        onInputChange={handleInput}
        options={suggestions}
        filterOptions={() => true}
        getOptionValue={(options) =>
          `${options.category.toLowerCase()}:${options.match.toLowerCase()}`
        }
        getOptionLabel={(options) => options.match.replaceAll("-", " ")}
        isLoading={isLoading}
        loadingMessage={() => loadingMessage || "Loading"}
        noOptionsMessage={() => noMatchesMessage || "No matches"}
        placeholder={placeholder || "Enter your text"}
        ref={containerElement}
        styles={customStyles}
        selectProps={{
          inputValue,
          containerElement,
          valueContainerElement,
          multiValueContainerElements,
        }}
        components={{
          DropdownIndicator: () => null,
          IndicatorSeparator: () => null,
          SelectContainer,
          Control,
          Input,
          ValueContainer,
          MultiValue,
          MultiValueContainer,
          MultiValueLabel,
          MultiValueRemove,
          Placeholder,
          Menu,
          MenuList,
          Option,
        }}
      />
    </div>
  );
};
